# AWS Secure File Upload System with Malware Scanning

A serverless, cloud-native secure file upload system built on AWS that automatically scans uploaded files for malware before storing them. This project demonstrates AWS security best practices including encryption, least privilege access, malware detection, and comprehensive audit logging.

## üéØ Project Overview

This system allows users to securely upload files through a web interface. Each uploaded file is:
1. Validated for type and size
2. Uploaded to S3 using presigned URLs
3. Automatically scanned for malware using ClamAV
4. Encrypted and stored securely if clean
5. Quarantined if suspicious
6. Logged for compliance and auditing

## üèóÔ∏è Architecture

```
User ‚Üí CloudFront (CDN) ‚Üí S3 (Static Website)
                              ‚Üì
                        API Gateway (REST API)
                              ‚Üì
                    Lambda (Generate Presigned URL)
                              ‚Üì
User uploads directly ‚Üí S3 Upload Bucket (Encrypted with KMS)
                              ‚Üì
                        S3 Event Notification
                              ‚Üì
                    Lambda (Malware Scanner with ClamAV)
                              ‚Üì
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚Üì                           ‚Üì
        S3 Clean Bucket              S3 Quarantine Bucket
        (Encrypted)                  (Encrypted)
                ‚Üì                           ‚Üì
        SNS Topic                    SNS Topic
        (Success)                    (Security Alert)
                ‚Üì                           ‚Üì
            Email                        Email
            
All activity logged to:
- CloudTrail (API calls)
- CloudWatch Logs (Lambda execution)
- S3 Access Logs
```

## üîí Security Features

### 1. Authentication & Authorization
- IAM roles with least privilege principle
- API Gateway with API key authentication
- Resource-based policies on S3 buckets
- Lambda execution roles with minimal permissions

### 2. Encryption
- **At Rest**: S3 buckets encrypted with AWS KMS customer-managed keys
- **In Transit**: TLS 1.2+ enforced for all connections
- **Presigned URLs**: Time-limited (15 minutes) secure upload URLs

### 3. Network Security
- VPC deployment for Lambda functions
- Private subnets with NAT Gateway
- Security Groups with minimal ingress rules
- AWS WAF protecting CloudFront and API Gateway

### 4. Malware Detection
- ClamAV antivirus engine running in Lambda
- Automatic virus definition updates
- Immediate quarantine of suspicious files
- Security team notifications via SNS

### 5. Audit & Compliance
- CloudTrail logging all API calls
- CloudWatch Logs for Lambda execution
- S3 Server Access Logging
- CloudWatch Alarms for security events

### 6. Input Validation
- File type whitelist enforcement
- Maximum file size limits (50MB)
- Content-Type validation
- Filename sanitization
- Rate limiting via API Gateway

## üìã Prerequisites

- AWS Account
- Terraform >= 1.5.0
- AWS CLI configured with appropriate credentials
- Docker (for building Lambda layers with ClamAV)
- Python 3.9+
- Git

## üöÄ Deployment

### Step 1: Clone and Configure

```bash
git clone <your-repo>
cd aws-secure-file-upload
```

### Step 2: Configure Variables

Edit `terraform/terraform.tfvars`:

```hcl
aws_region      = "us-east-1"
project_name    = "secure-file-upload"
environment     = "prod"
alert_email     = "security@yourcompany.com"
allowed_file_types = ["image/jpeg", "image/png", "application/pdf"]
max_file_size_mb = 50
```

### Step 3: Build Lambda Layers

```bash
cd lambda-layers
./build-clamav-layer.sh
cd ..
```

### Step 4: Deploy Infrastructure

```bash
cd terraform
terraform init
terraform plan
terraform apply
```

### Step 5: Deploy Frontend

The Terraform will output the CloudFront URL. Update the API endpoint in `frontend/upload.js` with the API Gateway URL from Terraform outputs, then:

```bash
aws s3 sync ../frontend s3://$(terraform output -raw website_bucket_name)
```

## üìÅ Project Structure

```
aws-secure-file-upload/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ architecture-diagram.png
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                 # Main Terraform configuration
‚îÇ   ‚îú‚îÄ‚îÄ providers.tf            # AWS provider configuration
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf            # Input variables
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf              # Output values
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars        # Variable values (gitignored)
‚îÇ   ‚îú‚îÄ‚îÄ iam.tf                  # IAM roles and policies
‚îÇ   ‚îú‚îÄ‚îÄ s3.tf                   # S3 buckets configuration
‚îÇ   ‚îú‚îÄ‚îÄ kms.tf                  # KMS encryption keys
‚îÇ   ‚îú‚îÄ‚îÄ lambda.tf               # Lambda functions
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway.tf          # API Gateway configuration
‚îÇ   ‚îú‚îÄ‚îÄ cloudfront.tf           # CloudFront distribution
‚îÇ   ‚îú‚îÄ‚îÄ cloudwatch.tf           # Monitoring and alarms
‚îÇ   ‚îú‚îÄ‚îÄ sns.tf                  # SNS topics for notifications
‚îÇ   ‚îú‚îÄ‚îÄ waf.tf                  # WAF rules
‚îÇ   ‚îî‚îÄ‚îÄ vpc.tf                  # VPC and networking
‚îú‚îÄ‚îÄ lambda-functions/
‚îÇ   ‚îú‚îÄ‚îÄ upload-handler/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handler.py          # Generate presigned URLs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ malware-scanner/
‚îÇ       ‚îú‚îÄ‚îÄ scanner.py          # ClamAV scanning logic
‚îÇ       ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ       ‚îî‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ lambda-layers/
‚îÇ   ‚îú‚îÄ‚îÄ build-clamav-layer.sh   # Script to build ClamAV layer
‚îÇ   ‚îî‚îÄ‚îÄ python-requirements/
‚îÇ       ‚îî‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ index.html              # Upload interface
‚îÇ   ‚îú‚îÄ‚îÄ upload.js               # Upload logic with presigned URLs
‚îÇ   ‚îî‚îÄ‚îÄ styles.css              # Styling
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ unit/
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ DEPLOYMENT.md
    ‚îú‚îÄ‚îÄ SECURITY.md
    ‚îî‚îÄ‚îÄ TROUBLESHOOTING.md
```

## üîß Configuration Options

### File Type Restrictions

Edit `terraform.tfvars` to customize allowed file types:

```hcl
allowed_file_types = [
  "image/jpeg",
  "image/png",
  "image/gif",
  "application/pdf",
  "application/zip",
  "text/plain"
]
```

### File Size Limits

```hcl
max_file_size_mb = 50  # Maximum 50MB per file
```

### Alert Email

```hcl
alert_email = "security-team@yourcompany.com"
```

## üìä Monitoring & Alerts

### CloudWatch Dashboard

Automatically created dashboard includes:
- Upload success/failure rates
- Malware detection events
- Lambda execution duration
- API Gateway 4xx/5xx errors
- S3 bucket metrics

### SNS Alerts

You'll receive email notifications for:
- ‚úÖ Successful file uploads (optional)
- üö® Malware detected
- ‚ö†Ô∏è Scanner failures
- üî• Lambda errors
- üìà Unusual activity patterns

### CloudWatch Alarms

Pre-configured alarms for:
- High error rates (>5%)
- Lambda throttling
- Scanner execution failures
- API Gateway latency spikes

## üß™ Testing

### Test File Upload

```bash
# Get upload URL
UPLOAD_URL=$(curl -X POST https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/get-upload-url \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{"filename": "test.pdf", "contentType": "application/pdf"}' | jq -r '.uploadUrl')

# Upload file
curl -X PUT "$UPLOAD_URL" \
  --upload-file test.pdf \
  -H "Content-Type: application/pdf"

# Check scan results (wait 30 seconds)
aws s3 ls s3://your-clean-bucket-name/
```

### Test Malware Detection

```bash
# Download EICAR test file (safe malware test file)
curl -o eicar.txt https://secure.eicar.org/eicar.com.txt

# Upload it (should be quarantined)
# Follow same process as above
```

## üí∞ Cost Estimation (Monthly)

Assuming 10,000 file uploads per month (5MB average):

| Service | Cost |
|---------|------|
| S3 Storage (50GB) | $1.15 |
| Lambda Invocations (20,000) | $0.40 |
| Lambda Duration | $2.00 |
| API Gateway (10,000 requests) | $0.035 |
| CloudFront (10GB transfer) | $0.85 |
| KMS Requests | $0.30 |
| CloudWatch Logs | $0.50 |
| SNS Notifications | $0.10 |
| **Total** | **~$5.35/month** |

*Free tier can reduce costs significantly for new AWS accounts*

## üîê Security Best Practices Demonstrated

1. **Least Privilege Access**: Every resource has minimal required permissions
2. **Defense in Depth**: Multiple layers of security (WAF, encryption, scanning)
3. **Encryption Everywhere**: Data encrypted at rest and in transit
4. **Audit Logging**: Complete audit trail of all activities
5. **Automated Scanning**: No manual intervention required
6. **Incident Response**: Automatic quarantine and alerting
7. **Network Isolation**: Lambda functions in private VPC subnets
8. **Secret Management**: No hardcoded credentials
9. **Input Validation**: Multiple validation layers
10. **Compliance Ready**: Structured logging for compliance requirements

## üìö Documentation

- [Deployment Guide](docs/DEPLOYMENT.md)
- [Security Architecture](docs/SECURITY.md)
- [Troubleshooting](docs/TROUBLESHOOTING.md)
- [API Documentation](docs/API.md)

## üêõ Troubleshooting

### Lambda Scanner Timeout
- Increase Lambda timeout in `terraform/lambda.tf`
- Check ClamAV database is up to date

### Files Not Being Scanned
- Verify S3 event notification configuration
- Check Lambda execution role permissions
- Review CloudWatch Logs for scanner function

### Upload Failures
- Verify presigned URL hasn't expired (15min limit)
- Check file size is within limits
- Verify Content-Type matches allowed types

## üöÄ Future Enhancements

- [ ] Add thumbnail generation for images
- [ ] Implement file deduplication
- [ ] Add user authentication (Cognito)
- [ ] Create admin dashboard
- [ ] Add file sharing capabilities
- [ ] Implement file versioning
- [ ] Add OCR for document indexing
- [ ] Multi-region replication

## üìÑ License

MIT License - See LICENSE file for details

## üë§ Author

Your Name - [GitHub](https://github.com/jmragsdale)

## üôè Acknowledgments

- ClamAV open-source antivirus engine
- AWS Security Best Practices documentation
- Terraform AWS modules community
